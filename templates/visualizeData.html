{% from '_header.html' import header %}
{% from '_footer.html' import footer %}
{{ header(current_user=current_user, is_admin=is_admin, page_title="Visualize Device Data", scripts=["https://cdn.jsdelivr.net/npm/chart.js"]) }}
<div class="container mt-4">
    <h1 class="mb-4">Visualize Device Data</h1>
    <div class="row mb-3">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
            <h5>1. Select Device(s)</h5>
            <select id="deviceSelect" class="form-select" multiple size="6">
                {% for id, name, _ in devices %}
                <option value="{{ id }}">{{ name }} ({{ id }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-12 col-md-6">
            <h5>2. Select Visualization Mode</h5>
            <select id="modeSelect" class="form-select mb-3">
                <option value="independent">Time series (Y vs Time)</option>
                <option value="xy">XY plot (X vs Y)</option>
            </select>
            <h5>3. Select Key(s)</h5>
            <div id="keySelectors"></div>
        </div>
    </div>
    <div class="mb-3 d-flex gap-2 flex-wrap">
        <button onclick="loadPlot()" class="btn btn-primary">Plot</button>
        <button onclick="exportCSV()" class="btn btn-secondary">Export CSV</button>
        <div class="form-check form-switch ms-3">
            <input class="form-check-input" type="checkbox" id="autoReloadPlotToggle" checked>
            <label class="form-check-label" for="autoReloadPlotToggle">Auto-reload plot</label>
        </div>
        <div class="form-check form-switch ms-3">
            <input class="form-check-input" type="checkbox" id="removeOffsetToggle">
            <label class="form-check-label" for="removeOffsetToggle">Remove offset (start x at 0)</label>
        </div>
            <div class="form-check form-switch ms-3">
                <input class="form-check-input" type="checkbox" id="logYAxisToggle">
                <label class="form-check-label" for="logYAxisToggle">Logarithmic Y axis</label>
            </div>
        <div class="ms-3">
            <label for="xAxisMode" class="form-label">X axis:</label>
            <select id="xAxisMode" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                <option value="date" selected>Date</option>
                <option value="milliseconds">Milliseconds</option> 
                <option value="seconds">Seconds</option>
                <option value="minutes">Minutes</option>
                <option value="hours">Hours</option>
                <option value="days">Days</option>
                <option value="weeks">Weeks</option>
                <option value="months">Months</option>
                <option value="years">Years</option>
            </select>
        </div>
        <div class="ms-3">
            <label for="sourceSelect" class="form-label">Data Source:</label>
            <select id="sourceSelect" class="form-select mb-3">
                <option value="device_id">Select Data by Device</option>
                <option value="report_id">Select Data by Report ID</option>
            </select>
        </div>
    </div>
    <hr>
    <div id="chartContainer"></div>
    <div class="mt-4 d-flex flex-column flex-md-row gap-2">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Back to index</a>
        <a href="{{ url_for('devices') }}" class="btn btn-info">Back to devices</a>
    </div>
</div>
<script>
let chart = null;
let lastSeries = [];

/* helpers */
function getSelectedValues(id) {
    return Array.from(document.getElementById(id).selectedOptions)
        .map(o => o.value);
}

document.getElementById("deviceSelect").addEventListener("change", loadKeys);
document.getElementById("modeSelect").addEventListener("change", loadKeys);
document.getElementById("sourceSelect").addEventListener("change", loadKeys);

document.getElementById("removeOffsetToggle").addEventListener("change", autoloadPlot);
document.getElementById("logYAxisToggle").addEventListener("change", autoloadPlot);
document.getElementById("xAxisMode").addEventListener("change", autoloadPlot);
document.getElementById("autoReloadPlotToggle").addEventListener("change", autoloadPlot);

function autoloadPlot() {
    if (document.getElementById("autoReloadPlotToggle").checked) {
        loadPlot();
    }
}

async function loadKeys() {
    const deviceIds = getSelectedValues("deviceSelect");
    if (deviceIds.length === 0) return;

    const source = document.getElementById("sourceSelect").value;
    let api_call = "";
    if( source === "report_id") {
        api_call = "/api/get/reportedValues/report_ids";
    } else if( source   === "device_id" ){
        api_call = "/api/get/reportedValues/keys";
    }

    const res = await fetch(api_call, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ device_ids: deviceIds })
    });

    const keys = await res.json();
    const mode = document.getElementById("modeSelect").value;
    const container = document.getElementById("keySelectors");

    container.innerHTML = "";

    if (mode === "independent") {
        container.innerHTML = `
            <select id="keys" multiple size="6">
                ${keys.map(k => `<option value="${k}">${k}</option>`).join("")}
            </select>
            <br><br>
            <label>
                <input type="checkbox" id="splitPlots">
                One plot per key
            </label>
        `;
        document.getElementById("splitPlots").addEventListener("change", autoloadPlot);
        document.getElementById("keys").addEventListener("change", autoloadPlot);
    } else {
        container.innerHTML = `
            X:
            <select id="xKey">
                ${keys.map(k => `<option value="${k}">${k}</option>`).join("")}
            </select>
            Y:
            <select id="yKey">
                ${keys.map(k => `<option value="${k}">${k}</option>`).join("")}
            </select>
        `;
        document.getElementById("xKey").addEventListener("change", autoloadPlot);
        document.getElementById("yKey").addEventListener("change", autoloadPlot);
    }


}

async function loadPlot() {
    const mode = document.getElementById("modeSelect").value;
    const payload = { mode };

    const source = document.getElementById("sourceSelect").value;

    if (mode === "independent") {
        if( source === "report_id") {
            payload.report_ids = getSelectedValues("deviceSelect");
        } else {
            payload.device_ids = getSelectedValues("deviceSelect");
        }
        payload.keys = getSelectedValues("keys");
    } else {
        if( source === "report_id") {
            // not supported, throw alert
            alert("XY plot mode with Report ID source is not supported.");
            return;
        } else {
            payload.device_id = getSelectedValues("deviceSelect")[0];
            payload.x_key = document.getElementById("xKey").value;
            payload.y_key = document.getElementById("yKey").value;
        }
    }

    let api_call = "";
    if( source === "report_id") {
        api_call = "/api/get/reportedValues/via_report_id";
    } else if( source   === "device_id" ){
        api_call = "/api/get/reportedValues/via_device_id";
    }

    const res = await fetch(api_call, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!Array.isArray(data)) {
        console.error("Expected array, got:", data);
        alert("Backend error â€“ see console");
        return;
    }
    lastSeries = data; 
    renderChart(mode, data);
}

let charts = [];

function clearCharts() {
    charts.forEach(c => c.destroy());
    charts = [];
    document.getElementById("chartContainer").innerHTML = "";
}

function renderChart(mode, data) {
    clearCharts();

    if (mode === "independent") {
        const split = document.getElementById("splitPlots").checked;
        const container = document.getElementById("chartContainer");
        const removeOffset = document.getElementById("removeOffsetToggle").checked;
        const xAxisMode = document.getElementById("xAxisMode").value;
        const logYAxis = document.getElementById("logYAxisToggle").checked;

        // Helper to transform x values
        function transformX(points) {
            if (!points.length) return points;
            let offset = removeOffset ? points[0].t : 0;
            return points.map(p => {
                let x = p.t - offset;
                switch (xAxisMode) {
                    case "milliseconds":
                        x = x * 1000;
                        break;
                    case "minutes":
                        x = x / 60;
                        break;
                    case "hours":
                        x = x / 3600;
                        break;
                    case "days":
                        x = x / 86400;
                        break;
                    case "weeks":
                        x = x / (86400 * 7);
                        break;
                    case "months":
                        x = x / (86400 * 30.4375); // average month
                        break;
                    case "years":
                        x = x / (86400 * 365.25); // average year
                        break;
                    case "date":
                        x = new Date((p.t) * 1000); // p.t is seconds
                        break;
                }
                return { x, y: p.v };
            });
        }

        // x axis label
        let xLabel = "Date";
        switch (xAxisMode) {
            case "seconds": xLabel = "Time (s)"; break;
            case "milliseconds": xLabel = "Time (ms)"; break;
            case "minutes": xLabel = "Time (min)"; break;
            case "hours": xLabel = "Time (h)"; break;
            case "days": xLabel = "Time (days)"; break;
            case "weeks": xLabel = "Time (weeks)"; break;
            case "months": xLabel = "Time (months)"; break;
            case "years": xLabel = "Time (years)"; break;
            case "date": xLabel = "Date"; break;
        }

        let xScale = {};
        if (xAxisMode === "date") {
            xScale = {
                type: "time",
                time: { unit: "minute", tooltipFormat: "yyyy-MM-dd HH:mm:ss" },
                title: { display: true, text: xLabel }
            };
        } else {
            xScale = {
                type: "linear",
                title: { display: true, text: xLabel }
            };
        }

        let yScale = {};
        if (logYAxis) {
            yScale = {
                type: "logarithmic",
                title: { display: true, text: "Value (log)" }
            };
        } else {
            yScale = {
                type: "linear",
                title: { display: true, text: "Value" }
            };
        }

        if (!split) {
            // ONE chart, many datasets
            const canvas = document.createElement("canvas");
            container.appendChild(canvas);

            const ctx = canvas.getContext("2d");
            charts.push(new Chart(ctx, {
                type: "line",
                data: {
                    datasets: data.map(s => ({
                        label: `${s.device_id}:${s.key}`,
                        data: transformX(s.points),
                    }))
                },
                options: {
                    scales: {
                        x: xScale,
                        y: yScale
                    }
                }
            }));
        } else {
            // MULTIPLE charts
            for (const s of data) {
                const canvas = document.createElement("canvas");
                canvas.style.marginBottom = "40px";
                container.appendChild(canvas);

                const ctx = canvas.getContext("2d");
                charts.push(new Chart(ctx, {
                    type: "line",
                    data: {
                        datasets: [{
                            label: `${s.device_id}:${s.key}`,
                            data: transformX(s.points),
                        }]
                    },
                    options: {
                        scales: {
                            x: xScale,
                            y: yScale
                        }
                    }
                }));
            }
        }
        return;
    }

    // XY mode (unchanged)
    const canvas = document.createElement("canvas");
    document.getElementById("chartContainer").appendChild(canvas);

    charts.push(new Chart(canvas.getContext("2d"), {
        type: "scatter",
        data: {
            datasets: [{ label: "XY", data }]
        },
        options: {
            scales: {
                x: { title: { display: true, text: "X" } },
                y: { title: { display: true, text: "Y" } }
            }
        }
    }));
}


function exportCSV() {
    if (!lastSeries.length) {
        alert("Nothing to export");
        return;
    }

    const rows = ["device_id,key,timestamp,value"];

    lastSeries.forEach(s => {
        s.points
        .slice()
        .sort((a, b) => a.t - b.t)
        .forEach(p => {
            rows.push(`"${s.device_id}","${s.key}",${p.t},${p.v}`);
        });
    });

    const blob = new Blob([rows.join("\n")], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "timeseries.csv";
    a.click();

    URL.revokeObjectURL(url);
}

loadKeys();
</script>

</div>
{{ footer(version=version, git_url=git_url) }}
</body>
</html>
