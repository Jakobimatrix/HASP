<!DOCTYPE html>
<html>
<head>
    <title>Visualize Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        select { min-width: 300px; }
    </style>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}">
</head>
<body>

<h1>Visualize Device Data</h1>

<h3>1. Select Device(s)</h3>
<select id="deviceSelect" multiple size="6">
    {% for id, name, _ in devices %}
    <option value="{{ id }}">{{ name }} ({{ id }})</option>
    {% endfor %}
</select>

<h3>2. Select Visualization Mode</h3>
<select id="modeSelect">
    <option value="independent">Time series (Y vs Time)</option>
    <option value="xy">XY plot (X vs Y)</option>
</select>

<h3>3. Select Key(s)</h3>
<div id="keySelectors"></div>

<br>
<button onclick="loadPlot()">Plot</button>
<button onclick="exportCSV()">Export CSV</button>

<hr>

<div id="chartContainer"></div>

<script>
let chart = null;
let lastSeries = [];

/* helpers */
function getSelectedValues(id) {
    return Array.from(document.getElementById(id).selectedOptions)
        .map(o => o.value);
}

document.getElementById("deviceSelect").addEventListener("change", loadKeys);
document.getElementById("modeSelect").addEventListener("change", loadKeys);

async function loadKeys() {
    const deviceIds = getSelectedValues("deviceSelect");
    if (deviceIds.length === 0) return;

    const res = await fetch("/api/keys", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ device_ids: deviceIds })
    });

    const keys = await res.json();
    const mode = document.getElementById("modeSelect").value;
    const container = document.getElementById("keySelectors");

    container.innerHTML = "";

    if (mode === "independent") {
        container.innerHTML = `
            <select id="keys" multiple size="6">
                ${keys.map(k => `<option value="${k}">${k}</option>`).join("")}
            </select>
            <br><br>
            <label>
                <input type="checkbox" id="splitPlots">
                One plot per key
            </label>
        `;
    } else {
        container.innerHTML = `
            X:
            <select id="xKey">
                ${keys.map(k => `<option value="${k}">${k}</option>`).join("")}
            </select>
            Y:
            <select id="yKey">
                ${keys.map(k => `<option value="${k}">${k}</option>`).join("")}
            </select>
        `;
    }
}

async function loadPlot() {
    const mode = document.getElementById("modeSelect").value;
    const payload = { mode };

    if (mode === "independent") {
        payload.device_ids = getSelectedValues("deviceSelect");
        payload.keys = getSelectedValues("keys");
    } else {
        payload.device_id = getSelectedValues("deviceSelect")[0];
        payload.x_key = document.getElementById("xKey").value;
        payload.y_key = document.getElementById("yKey").value;
    }

    const res = await fetch("/api/data", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!Array.isArray(data)) {
        console.error("Expected array, got:", data);
        alert("Backend error â€“ see console");
        return;
    }
    lastSeries = data; 
    renderChart(mode, data);
}

let charts = [];

function clearCharts() {
    charts.forEach(c => c.destroy());
    charts = [];
    document.getElementById("chartContainer").innerHTML = "";
}

function renderChart(mode, data) {
    clearCharts();

    if (mode === "independent") {
        const split = document.getElementById("splitPlots").checked;
        const container = document.getElementById("chartContainer");

        if (!split) {
            // ONE chart, many datasets
            const canvas = document.createElement("canvas");
            container.appendChild(canvas);

            const ctx = canvas.getContext("2d");
            charts.push(new Chart(ctx, {
                type: "line",
                data: {
                    datasets: data.map(s => ({
                        label: `${s.device_id}:${s.key}`,
                        data: s.points.map(p => ({ x: p.t, y: p.v })),
                    }))
                },
                options: {
                    scales: {
                        x: { type: "linear", title: { display: true, text: "Time (s)" } },
                        y: { title: { display: true, text: "Value" } }
                    }
                }
            }));
        } else {
            // MULTIPLE charts
            for (const s of data) {
                const canvas = document.createElement("canvas");
                canvas.style.marginBottom = "40px";
                container.appendChild(canvas);

                const ctx = canvas.getContext("2d");
                charts.push(new Chart(ctx, {
                    type: "line",
                    data: {
                        datasets: [{
                            label: `${s.device_id}:${s.key}`,
                            data: s.points.map(p => ({ x: p.t, y: p.v })),
                        }]
                    },
                    options: {
                        scales: {
                            x: { type: "linear", title: { display: true, text: "Time (s)" } },
                            y: { title: { display: true, text: "Value" } }
                        }
                    }
                }));
            }
        }
        return;
    }

    // XY mode (unchanged)
    const canvas = document.createElement("canvas");
    document.getElementById("chartContainer").appendChild(canvas);

    charts.push(new Chart(canvas.getContext("2d"), {
        type: "scatter",
        data: {
            datasets: [{ label: "XY", data }]
        },
        options: {
            scales: {
                x: { title: { display: true, text: "X" } },
                y: { title: { display: true, text: "Y" } }
            }
        }
    }));
}


function exportCSV() {
    if (!lastSeries.length) {
        alert("Nothing to export");
        return;
    }

    const rows = ["device_id,key,timestamp,value"];

    lastSeries.forEach(s => {
        s.points
        .slice()
        .sort((a, b) => a.t - b.t)
        .forEach(p => {
            rows.push(`"${s.device_id}","${s.key}",${p.t},${p.v}`);
        });
    });

    const blob = new Blob([rows.join("\n")], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "timeseries.csv";
    a.click();

    URL.revokeObjectURL(url);
}

loadKeys();
</script>

<p><a href="{{ url_for('index') }}">Back to index</a></p>
<p><a href="{{ url_for('devices') }}">Back to devices</a></p>

</body>
</html>
